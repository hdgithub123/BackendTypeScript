CREATE DATABASE MYDATABASE CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

use MYDATABASE;
-- Các quy ước
-- các bẳng được lấy theo:
-- id: id CHAR(36) PRIMARY KEY DEFAULT (UUID()), CHECK (id <> ''),
-- code: code VARCHAR(100) NOT NULL, -- mã do người dùng đặt
-- name: name VARCHAR(255) NOT NULL,
-- các khác không đặc biệt như address, image,.. thì lưu VARCHAR(255),

CREATE TABLE organizations (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    CHECK (id <> ''),
    code VARCHAR(100) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    address VARCHAR(255),
    isActive TINYINT(1) NOT NULL DEFAULT 0,
    isSystem TINYINT(1) DEFAULT 0, 
    createdBy VARCHAR(100),
    updatedBy VARCHAR(100),
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO organizations 
VALUES 
('00000000-0000-0000-0000-000000000001', 'RootOrganization', 'System Org', '', 1, 1, 'system', 'system', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP);

INSERT INTO organizations (
    code, name, address, isActive, isSystem, createdBy, updatedBy
) VALUES
    ('ORG001', 'Công ty TNHH ABC', '123 Đường Láng, Hà Nội', 1, 0, 'admin', 'admin'),
    ('ORG002', 'Công ty B', 'Trụ sở chính - Tầng 5', 0, 1, 'system', 'system'),
    ('ORG003', 'Công ty C', '', 1, 0, 'user01', 'user01');

SET @RootOrganization = (SELECT id FROM organizations WHERE id = '00000000-0000-0000-0000-000000000001');
SET @Organizations1 = (SELECT id FROM organizations WHERE code = 'ORG001');
SET @Organizations2 = (SELECT id FROM organizations WHERE code = 'ORG002');
SET @Organizations3 = (SELECT id FROM organizations WHERE code = 'ORG003');


CREATE TABLE users (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    CHECK (id <> ''),
    code VARCHAR(100) NOT NULL,
    password VARCHAR(255) NOT NULL,
    name VARCHAR(255),
    address VARCHAR(255),
    email VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    image VARCHAR(255),
    organizationId CHAR(36) NOT NULL,
    FOREIGN KEY (organizationId) REFERENCES organizations(id) ON DELETE CASCADE,
    UNIQUE (organizationId, code),
	UNIQUE (organizationId, email),
    isActive TINYINT(1) NOT NULL DEFAULT 0,
    isSystem TINYINT(1) DEFAULT 0, 
    createdBy VARCHAR(100),
    updatedBy VARCHAR(100),
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO users (
    code, password, name, address, email, phone, image, organizationId,
    isActive, isSystem, createdBy, updatedBy
) VALUES
('admin', 'hashed_password_1', 'Nguyễn Văn A', '12 Lê Lợi, Hà Nội', 'a.nguyen@example.com', '0901234567', 'avatar1.jpg', @RootOrganization, 1, 0, 'admin', 'admin'),
('admin', 'hashed_password_2', 'System Admin', 'Trụ sở chính', 'sys.admin@example.com', '0987654321', 'sys_avatar.jpg', @Organizations1, 1, 1, 'system', 'system'),
('admin', 'hashed_password_3', 'Trần Thị B', '45 Nguyễn Trãi, TP.HCM', 'b.tran@example.com', '0912345678', 'avatar2.jpg', @Organizations2, 1, 0, 'user01', 'user01'),
('admin', 'hashed_password_3', 'Trần Thị B', '45 Nguyễn Trãi, TP.HCM', 'b.tran@example.com', '0912345678', 'avatar2.jpg', @Organizations3, 1, 0, 'user01', 'user01'),
('user1', 'hashed_password_4', 'Phạm Văn C', '88 Trần Hưng Đạo, Đà Nẵng', 'c.pham@example.com', '0934567890', 'avatar3.jpg', @Organizations1, 0, 0, 'admin', 'admin'),
('user2', 'hashed_password_5', 'System Bot', 'Nội bộ', 'bot@example.com', '0976543210', 'bot_avatar.jpg', @Organizations1, 0, 1, 'system', 'system');

-- Cập nhật mật khẩu đã băm cho người dùng 'admin' và 'user1' là với pass đã mã hoá là admin
SET SQL_SAFE_UPDATES = 0;
UPDATE users 
SET password = '$2b$10$KzyhMc9ylHx6xye2T11SruhtOQ7YPLrx/AlRBxz.n6NJKA7LbwJDy'
WHERE code = 'admin';

UPDATE users 
SET password = '$2b$10$KzyhMc9ylHx6xye2T11SruhtOQ7YPLrx/AlRBxz.n6NJKA7LbwJDy'
WHERE code = 'user1';


SET @rootAdmin = (SELECT id FROM users WHERE code = 'admin' AND organizationId = @RootOrganization);
SET @admin1 = (SELECT id FROM users WHERE code = 'admin' AND organizationId = @Organizations1);
SET @user1 = (SELECT id FROM users WHERE code = 'user1' AND organizationId = @Organizations1);
SET @user2 = (SELECT id FROM users WHERE code = 'user2' AND organizationId = @Organizations1);
SET @admin2 = (SELECT id FROM users WHERE code = 'admin' AND organizationId = @Organizations2);
SET @admin3 = (SELECT id FROM users WHERE code = 'admin' AND organizationId = @Organizations3);


CREATE TABLE roles (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    name VARCHAR(255) NOT NULL,
    code VARCHAR(100) NOT NULL, -- Mã tùy chỉnh có thể thay đổi theo organizationsId
    description TEXT,
    organizationId CHAR(36) NOT NULL,
    FOREIGN KEY (organizationId) REFERENCES organizations(id) ON DELETE CASCADE,
    UNIQUE (organizationId, code),
    isSystem TINYINT(1) DEFAULT 0,
    createdBy VARCHAR(100),
    updatedBy VARCHAR(100),
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CHECK (id <> '')
);


INSERT INTO roles (name, code, description,organizationId,isSystem)
VALUES
    ('Administrator', 'Administrator', 'Quản lý toàn hệ thống', @RootOrganization, FALSE),
    ('Administrator', 'Administrator', 'Quản lý toàn hệ thống', @Organizations1, FALSE),
    ('Administrator', 'Administrator', 'Quản lý toàn hệ thống', @Organizations2,FALSE),
    ('Administrator', 'Administrator', 'Quản lý toàn hệ thống', @Organizations3,FALSE),
    ('Editor', 'EDITOR_ROLE', 'Có quyền chỉnh sửa nội dung', @Organizations1,FALSE),
    ('Viewer', 'VIEWER_ROLE', 'Chỉ có quyền xem nội dung', @Organizations1, FALSE),
    ('Manager', 'MANAGER_ROLE', 'Quản lý người dùng và phân quyền', @Organizations1,FALSE),
    ('Support', 'SUPPORT_ROLE', 'Hỗ trợ kỹ thuật và người dùng', @Organizations1, FALSE);



SET @Administrator1 = (SELECT id FROM roles WHERE code = 'Administrator' AND organizationId = @Organizations1 );

SET @RootRoleAdministrator = (SELECT id FROM roles WHERE code = 'Administrator' AND organizationId = @RootOrganization );

CREATE TABLE rights (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    name VARCHAR(50) NOT NULL,
    code VARCHAR(50) UNIQUE NOT NULL, -- Mã quyền có thể thay đổi
    description TEXT,
    createdBy VARCHAR(100),
    updatedBy VARCHAR(100),
    isSystem TINYINT(1) DEFAULT 0,
    isOwner TINYINT(1) DEFAULT 0,
    isOrganization TINYINT(1) DEFAULT 0,
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CHECK (id <> '')
);



INSERT INTO rights (name, code, description, createdBy,isSystem,isOwner,isOrganization, isOrganization) VALUES
('Login', 'Login', 'Quyền đăng nhập hệ thống', 'System', TRUE, TRUE, TRUE),
('Loguot', 'Loguot', 'Quyền đăng xuất khỏi hệ thống', 'System', TRUE, TRUE, TRUE),

-- User
('view user', 'GetUser', 'Xem thông tin một người dùng', 'System', TRUE, TRUE, TRUE),
('add user', 'PostUser', 'Thêm một người dùng mới', 'System', TRUE, TRUE, TRUE),
('update user', 'PutUser', 'Cập nhật thông tin người dùng', 'System', TRUE, TRUE, TRUE),
('Delete user', 'DeleteUser', 'Xóa một người dùng', 'System', TRUE, TRUE, TRUE),
('view users', 'GetUsers', 'Xem danh sách người dùng', 'System', TRUE, TRUE, TRUE),
('add users', 'PostUsers', 'Thêm nhiều người dùng', 'System', TRUE, TRUE, TRUE),
('update users', 'PutUsers', 'Cập nhật danh sách người dùng', 'System', TRUE, TRUE, TRUE),
('Delete users', 'DeleteUsers', 'Xóa nhiều người dùng', 'System', TRUE, TRUE, TRUE),
('export Users', 'ExportUsers', 'Xuất khẩu danh sách excell', 'System', TRUE, TRUE, TRUE),

-- Rights
('view Right', 'GetRight', 'Xem thông tin một quyền', 'System', TRUE, FALSE, TRUE),
('view Rights', 'GetRights', 'Xem danh sách quyền hệ thống', 'System', TRUE, FALSE, TRUE),
('export Rights', 'ExportRights', 'Xuất khẩu danh sách quyền', 'System', TRUE, FALSE, TRUE),


-- Role
('view role', 'GetRole', 'Xem một vai trò cụ thể', 'System', TRUE, TRUE, TRUE),
('add role', 'PostRole', 'Thêm một vai trò mới', 'System', TRUE, TRUE, TRUE),
('update role', 'PutRole', 'Cập nhật vai trò', 'System', TRUE, TRUE, TRUE),
('Delete role', 'DeleteRole', 'Xóa một vai trò', 'System', TRUE, TRUE, TRUE),
('view Roles', 'GetRoles', 'Xem danh sách vai trò', 'System', TRUE, TRUE, TRUE),
('add Roles', 'PostRoles', 'Thêm nhiều vai trò', 'System', TRUE, TRUE, TRUE),
('update Roles', 'PutRoles', 'Cập nhật nhiều vai trò', 'System', TRUE, TRUE, TRUE),
('Delete Roles', 'DeleteRoles', 'Xóa nhiều vai trò', 'System', TRUE, TRUE, TRUE),
('export Roles', 'ExportRoles', 'Xuất khẩu danh sách excell', 'System', TRUE, TRUE, TRUE),


-- RoleVsRight
('view RoleVsRight', 'GetRoleRight', 'Xem quyền gán cho vai trò', 'System', TRUE, TRUE, TRUE),
('add RoleRight', 'PostRoleRight', 'Thêm quyền vào vai trò', 'System', TRUE, TRUE, TRUE),
('update RoleRight', 'PutRoleRight', 'Cập nhật quyền của vai trò', 'System', TRUE, TRUE, TRUE),
('Delete RoleRight', 'DeleteRoleRight', 'Xóa quyền khỏi vai trò', 'System', TRUE, TRUE, TRUE),
('view RoleRights', 'GetRoleRights', 'Xem danh sách quyền theo vai trò', 'System', TRUE, TRUE, TRUE),
('add RoleRights', 'PostRoleRights', 'Gán nhiều quyền cho vai trò', 'System', TRUE, TRUE, TRUE),
('update RoleRights', 'PutRoleRights', 'Cập nhật nhiều quyền cho vai trò', 'System', TRUE, TRUE, TRUE),
('Delete RoleRights', 'DeleteRoleRights', 'Xóa nhiều quyền khỏi vai trò', 'System', TRUE, TRUE, TRUE),
('export RoleRights', 'ExportRoleRights', 'Xuất khẩu danh sách excell', 'System', TRUE, TRUE, TRUE),

-- UserZoneRole
('view UserZoneRole', 'GetUserZoneRole', 'Xem vai trò của người dùng theo khu vực', 'System', TRUE, TRUE, TRUE),
('add UserZoneRole', 'PostUserZoneRole', 'Gán vai trò cho người dùng theo khu vực', 'System', TRUE, TRUE, TRUE),
('update UserZoneRole', 'PutUserZoneRole', 'Cập nhật vai trò của người dùng theo khu vực', 'System', TRUE, TRUE, TRUE),
('Delete UserZoneRole', 'DeleteUserZoneRole', 'Xóa vai trò khỏi người dùng theo khu vực', 'System', TRUE, TRUE, TRUE),
('view UserZoneRoles', 'GetUserZoneRoles', 'Xem nhiều vai trò của người dùng theo khu vực', 'System', TRUE, TRUE, TRUE),
('add UserZoneRoles', 'PostUserZoneRoles', 'Gán nhiều vai trò cho người dùng theo khu vực', 'System', TRUE, TRUE, TRUE),
('update UserZoneRoles', 'PutUserZoneRoles', 'Cập nhật nhiều vai trò của người dùng theo khu vực', 'System', TRUE, TRUE, TRUE),
('Delete UserZoneRoles', 'DeleteUserZoneRoles', 'Xóa nhiều vai trò khỏi người dùng theo khu vực', 'System', TRUE, TRUE, TRUE),
('export UserZoneRoles', 'ExportUserZoneRoles', 'Xuất khẩu danh sách excell', 'System', TRUE, TRUE, TRUE);




CREATE TABLE roles_rights (
    roleId CHAR(36),
    rightId CHAR(36),
    isActive TINYINT(1) NOT NULL,
    isSystem TINYINT(1) DEFAULT 0,
    PRIMARY KEY (roleId, rightId),
    FOREIGN KEY (roleId) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (rightId) REFERENCES rights(id) ON DELETE CASCADE,
    CHECK (roleId <> '' AND rightId <> '')
);




CREATE TABLE branches (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    name VARCHAR(255) NOT NULL,
    code VARCHAR(100) UNIQUE NOT NULL, -- Mã chi nhánh có thể thay đổi
    address TEXT,
    description TEXT,
    organizationId CHAR(36) NOT NULL,
    FOREIGN KEY (organizationId) REFERENCES organizations(id) ON DELETE CASCADE,
    UNIQUE (organizationId, code),
    isIndependent TINYINT(1) DEFAULT 0,
    isActive TINYINT(1) DEFAULT 0,
    isSystem TINYINT(1) DEFAULT 0,
    createdBy VARCHAR(100),
    updatedBy VARCHAR(100),
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    CHECK (id <> '')
);

-- tạo branch cho RootOrganization
INSERT INTO branches (id, name, code, address, description, organizationId,isActive, createdBy) VALUES
('00000000-0000-0000-0000-000000000001', 'Root Branch', 'RootBranch', 'Trụ sở chính', 'Chi nhánh gốc', @RootOrganization, 1, 'system');

SET @RootBranch = (SELECT id FROM branches WHERE id = '00000000-0000-0000-0000-000000000001');

-- tạo chi nhánh General
INSERT INTO branches (id, name, code, address, description, organizationId,isActive, createdBy) VALUES
(UUID(), 'General', 'General', 'Trụ sở chính', 'Chi nhánh tổng', @Organizations1, 1, 'system');



INSERT INTO rights (name, code, description, createdBy,isSystem,isOwner,isOrganization) VALUES
-- branch
('view Branch', 'GetBranch', 'Xem thông tin một chi nhánh', 'System', TRUE, TRUE, TRUE),
('add Branch', 'PostBranch', 'Thêm một chi nhánh mới', 'System', TRUE, TRUE, TRUE),
('update Branch', 'PutBranch', 'Cập nhật thông tin chi nhánh', 'System', TTRUE, TRUE, TRUE),
('Delete Branch', 'DeleteBranch', 'Xóa một chi nhánh', 'System', TRUE, TRUE, TRUE),
('view Branches', 'GetBranches', 'Xem danh sách chi nhánh', 'System', TRUE, TRUE, TRUE),
('add Branches', 'PostBranches', 'Thêm nhiều chi nhánh', 'System', TRUE, TRUE, TRUE),
('update Branches', 'PutBranches', 'Cập nhật danh sách chi nhánh', 'System', TRUE, TRUE, TRUE),
('Delete Branches', 'DeleteBranches', 'Xóa nhiều chi nhánh', 'System', TRUE, TRUE, TRUE),
('export Branches', 'ExportBranches', 'Xuất khẩu danh sách excell', 'System', TRUE, TRUE, TRUE);






CREATE TABLE departments (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    name VARCHAR(255) NOT NULL,
    code VARCHAR(100) NOT NULL, -- Mã phòng ban có thể thay đổi
    address TEXT,
    description TEXT,
    parentId CHAR(36) NULL,
    branchId CHAR(36) NOT NULL,
    organizationId CHAR(36) NOT NULL,
    FOREIGN KEY (branchId) REFERENCES branches(id) ON DELETE CASCADE,
    FOREIGN KEY (organizationId) REFERENCES organizations(id) ON DELETE CASCADE,
    UNIQUE (organizationId, code),
    isActive TINYINT(1) DEFAULT 0,
    isSystem TINYINT(1) DEFAULT 0,
    createdBy VARCHAR(100),
    updatedBy VARCHAR(100),
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (parentId) REFERENCES departments(id) ON DELETE RESTRICT,
    CHECK (id <> '')
);


-- Trigger để kiểm tra vòng lặp trong cấu trúc tổ chức (phòng ban)

DELIMITER $$

CREATE TRIGGER trg_departments_no_loop_insert
BEFORE INSERT ON departments
FOR EACH ROW
BEGIN
    DECLARE hasLoop INT DEFAULT 0;

    IF NEW.parentId IS NOT NULL THEN
        SELECT COUNT(*) INTO hasLoop
        FROM (
            WITH RECURSIVE cte AS (
                SELECT id, parentId
                FROM departments
                WHERE id = NEW.parentId

                UNION ALL

                SELECT d.id, d.parentId
                FROM departments d
                JOIN cte c ON d.id = c.parentId
            )
            SELECT id FROM cte
        ) t
        WHERE t.id = NEW.id;

        IF hasLoop > 0 THEN
            SIGNAL SQLSTATE '45000'
                SET MESSAGE_TEXT = 'Hierarchy loop detected (INSERT departments).';
        END IF;
    END IF;
END$$
DELIMITER ;

DELIMITER $$
CREATE TRIGGER trg_departments_no_loop_update
BEFORE UPDATE ON departments
FOR EACH ROW
BEGIN
    DECLARE v_parent CHAR(36);
    DECLARE iter INT DEFAULT 0;

    IF NEW.parentId IS NOT NULL AND (OLD.parentId IS NULL OR NEW.parentId <> OLD.parentId) THEN
        IF NEW.parentId = NEW.id THEN
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Self-parent not allowed (UPDATE).';
        END IF;

        SET v_parent = NEW.parentId;

        loop_check2: LOOP
            SET iter = iter + 1;
            IF iter > 1000 THEN
                SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Too deep or existing cycle detected (UPDATE).';
            END IF;

            IF v_parent IS NULL THEN
                LEAVE loop_check2;
            END IF;

            IF v_parent = NEW.id THEN
                SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Hierarchy loop detected (UPDATE departments).';
            END IF;

            SELECT parentId INTO v_parent FROM departments WHERE id = v_parent LIMIT 1;
        END LOOP loop_check2;
    END IF;
END$$

DELIMITER ;



DELIMITER $$
CREATE TRIGGER trg_one_root_department_branch
BEFORE INSERT ON departments
FOR EACH ROW
BEGIN
    IF NEW.parentId IS NULL THEN
        -- Check if branch already has a root department
        IF (SELECT COUNT(*) 
            FROM departments 
            WHERE parentId IS NULL 
              AND branchId = NEW.branchId) > 0 THEN
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = 'Each branch can only have one root department';
        END IF;
    END IF;
END$$

DELIMITER ;


DELIMITER $$

CREATE TRIGGER trg_one_root_department_branch_update
BEFORE UPDATE ON departments
FOR EACH ROW
BEGIN
    IF NEW.parentId IS NULL AND OLD.parentId IS NOT NULL THEN
        -- Check if another root department already exists in the same branch
        IF (SELECT COUNT(*) 
            FROM departments 
            WHERE parentId IS NULL 
              AND branchId = NEW.branchId 
              AND id <> OLD.id) > 0 THEN
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = 'Each branch can only have one root department';
        END IF;
    END IF;
END$$

DELIMITER ;

-- tao phòng ban gốc cho chi nhánh RootBranch
INSERT INTO departments (id, name, code, address, description, parentId, branchId, organizationId, isActive, createdBy) VALUES
('00000000-0000-0000-0000-000000000001', 'Root Department', 'RootDepartment', 'Trụ sở chính', 'Phòng ban gốc', NULL, @RootBranch, @RootOrganization, 1, 'system');


INSERT INTO rights (name, code, description, createdBy,isSystem,isOwner,isOrganization) VALUES
-- department
('view Department', 'GetDepartment', 'Xem thông tin một phòng ban', 'System', TRUE, TRUE, TRUE),
('add Department', 'PostDepartment', 'Thêm một phòng ban mới', 'System', TRUE, TRUE, TRUE),
('update Department', 'PutDepartment', 'Cập nhật thông tin phòng ban', 'System', TRUE, TRUE, TRUE),
('Delete Department', 'DeleteDepartment', 'Xóa một phòng ban', 'System', TRUE, TRUE, TRUE),
('view Departments', 'GetDepartments', 'Xem danh sách phòng ban', 'System', TRUE, TRUE, TRUE),
('add Departments', 'PostDepartments', 'Thêm nhiều phòng ban', 'System', TRUE, TRUE, TRUE),
('update Departments', 'PutDepartments', 'Cập nhật danh sách phòng ban', 'System', TRUE, TRUE, TRUE),
('Delete Departments', 'DeleteDepartments', 'Xóa nhiều phòng ban', 'System', TRUE, TRUE, TRUE),
('export Departments', 'ExportDepartments', 'Xuất khẩu danh sách excell', 'System', TRUE, TRUE, TRUE);



CREATE TABLE users_departments_roles (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    userId CHAR(36),
    roleId CHAR(36),
    departmentId CHAR(36),
    isActive BOOLEAN,
    isSystem TINYINT(1) DEFAULT 0,
    createdBy VARCHAR(100),
    updatedBy VARCHAR(100),
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE (userId, roleId, departmentId),
    FOREIGN KEY (userId) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (roleId) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (departmentId) REFERENCES departments(id) ON DELETE CASCADE,
    CHECK (userId <> '' AND roleId <> '' AND departmentId <> '' AND id <> '')
);


INSERT INTO rights (name, code, description, createdBy,isSystem,isOwner,isOrganization) VALUES
-- users_departments_roles
('view UserDepartmentRole', 'GetUserDepartmentRole', 'Xem nhiều vai trò của người dùng theo phòng ban', 'System',TRUE, TRUE, TRUE),
('add UserDepartmentRole', 'PostUserDepartmentRole', 'Gán nhiều vai trò cho người dùng theo phòng ban', 'System', TRUE, TRUE, TRUE),
('update UserDepartmentRole', 'PutUserDepartmentRole', 'Cập nhật nhiều vai trò của người dùng theo phòng ban', 'System', TRUE, TRUE, TRUE),
('Delete UserDepartmentRole', 'DeleteUserDepartmentRole', 'Xóa nhiều vai trò khỏi người dùng theo phòng ban', 'System', TRUE, TRUE, TRUE),

('view UserDepartmentsRoles', 'GetUserDepartmentRoles', 'Xem vai trò của người dùng theo phòng ban', 'System', TRUE, TRUE, TRUE),
('add UserDepartmentsRoles', 'PostUserDepartmentRoles', 'Gán vai trò cho người dùng theo phòng ban', 'System', TRUE, TRUE, TRUE),
('update UserDepartmentsRoles', 'PutUserDepartmentRoles', 'Cập nhật vai trò của người dùng theo phòng ban', 'System', TRUE, TRUE, TRUE),
('Delete UserDepartmentsRoles', 'DeleteUserDepartmentRoles', 'Xóa vai trò khỏi người dùng theo phòng ban', 'System', TRUE, TRUE, TRUE),
('export UserDepartmentsRoles', 'ExportUserDepartmentsRoles', 'Xuất khẩu danh sách excell', 'System', TRUE, TRUE, TRUE);

-- gán quyền cho Administrator cho admin của root organization
INSERT INTO users_departments_roles (userId, roleId, departmentId, isActive, createdBy) VALUES
(@rootAdmin, @RootRoleAdministrator, '00000000-0000-0000-0000-000000000001', TRUE, 'system'); -- ad admin cho toan bo phong ban root




CREATE TABLE activityLogs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    organizationId CHAR(36),
    departmentId CHAR(36),
    branchId CHAR(36),
    userId CHAR(36),              -- ID người dùng thực hiện hành động
    username VARCHAR(100),              -- Tên người dùng thực hiện hành động
    time DATETIME DEFAULT CURRENT_TIMESTAMP,     -- Thời gian ghi log
    action VARCHAR(50),                 -- Loại hành động: INSERT, UPDATE, DELETE, ACCESS...
    tableName VARCHAR(100),                     -- Tên bảng bị tác động
    description TEXT,                            -- Mô tả chi tiết hành động
    ip VARCHAR(45),                              -- Địa chỉ IP của client
    oldData JSON,                               -- Dữ liệu cũ (trước khi thay đổi)
    activeData JSON,                               -- Dữ liệu mới (sau khi thay đổi)
    browserInfo JSON,                           -- Thông tin trình duyệt (user-agent, OS, device...)
    protocol VARCHAR(10),                        -- Giao thức: http hoặc https
    hostname VARCHAR(255),                       -- Tên miền hoặc host truy cập
    originalUrl TEXT,                           -- URL đầy đủ được truy cập
    method VARCHAR(10),                          -- Phương thức HTTP: GET, POST, PUT...
    port INT,                                    -- Cổng kết nối
    secure BOOLEAN                               -- Có dùng HTTPS không (true/false)
);

INSERT INTO rights (name, code, description, createdBy,isSystem,isOwner,isOrganization) VALUES
-- activitylog
('view ActivityLogs','GetActivityLogs','Xem nhật ký truy cập','System' , TRUE, TRUE, TRUE),
('add ActivityLogs','PostActivityLogs','Thêm vào nhật ký truy cập','System', TRUE, TRUE, TRUE),
('Delete ActivityLogs','DeleteActivityLogs','Xóa nhật ký truy cập','System', TRUE, TRUE, TRUE);





CREATE TABLE template_contents (
  id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
  code VARCHAR(100) UNIQUE NOT NULL, --chua sua lai
  organizationId CHAR(36) NOT NULL,
  FOREIGN KEY (organizationId) REFERENCES organizations(id) ON DELETE CASCADE,
  UNIQUE (organizationId, code),
  name VARCHAR(255) NOT NULL,
  scopeName VARCHAR(255) NOT NULL,
  content JSON,
  description VARCHAR(255),
  isActive TINYINT(1) NOT NULL DEFAULT 1,
  isSystem TINYINT(1) DEFAULT 0,
  createdBy VARCHAR(100),
  updatedBy VARCHAR(100),
  createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  CHECK (id <> '')
);


INSERT INTO rights (name, code, description, createdBy,isSystem,isOwner,isOrganization) VALUES
-- template contents
('view TemplateContent', 'GetTemplateContent', 'Xem nội dung mẫu', 'System', TRUE, TRUE, TRUE),
('add TemplateContent', 'PostTemplateContent', 'Thêm nội dung mẫu', 'System', TRUE, TRUE, TRUE),
('update TemplateContent', 'PutTemplateContent', 'Cập nhật nội dung mẫu', 'System', TRUE, TRUE, TRUE),
('Delete TemplateContent', 'DeleteTemplateContent', 'Xóa nội dung mẫu', 'System', TRUE, TRUE, TRUE),
('view TemplateContents', 'GetTemplateContents', 'Xem nhiều nội dung mẫu', 'System', TRUE, TRUE, TRUE),
('add TemplateContents', 'PostTemplateContents', 'Thêm nhiều nội dung mẫu', 'System', TRUE, TRUE, TRUE),
('update TemplateContents', 'PutTemplateContents', 'Cập nhật nhiều nội dung mẫu', 'System', TRUE, TRUE, TRUE),
('Delete TemplateContents', 'DeleteTemplateContents', 'Xóa nhiều nội dung mẫu', 'System', TRUE, TRUE, TRUE);


INSERT INTO rights (name, code, description, createdBy,isSystem,isOwner,isOrganization) VALUES
-- user template contents
('view UserTemplateContent', 'GetUserTemplateContent', 'Xem nội dung mẫu của người dùng', 'System', TRUE, TRUE, TRUE),
('add UserTemplateContent', 'PostUserTemplateContent', 'Thêm nội dung mẫu của người dùng', 'System', TRUE, TRUE, TRUE),
('update UserTemplateContent', 'PutUserTemplateContent', 'Cập nhật nội dung mẫu của người dùng', 'System', TRUE, TRUE, TRUE),
('Delete UserTemplateContent', 'DeleteUserTemplateContent', 'Xóa nội dung mẫu của người dùng', 'System', TRUE, TRUE, TRUE);


INSERT INTO rights (name, code, description, createdBy,isSystem,isOwner,isOrganization) VALUES
-- user template contents
('view UsersTemplateContent', 'GetUsersTemplateContent', 'Xem nội dung mẫu của danh sách người dùng', 'System', TRUE, TRUE, TRUE),
('add UsersTemplateContent', 'PostUsersTemplateContent', 'Thêm nội dung mẫu của danh sách người dùng', 'System', TRUE, TRUE, TRUE),
('update UsersTemplateContent', 'PutUsersTemplateContent', 'Cập nhật nội dung mẫu của danh sách người dùng', 'System', TRUE, TRUE, TRUE),
('Delete UsersTemplateContent', 'DeleteUsersTemplateContent', 'Xóa nội dung mẫu của danh sách người dùng', 'System', TRUE, TRUE, TRUE);



INSERT INTO rights (name, code, description, createdBy,isSystem,isOwner,isOrganization) VALUES
-- organization
('view Organization', 'GetOrganization', 'Xem thông tin một tổ chức', 'System', TRUE, TRUE, FALSE),
('add Organization', 'PostOrganization', 'Thêm một tổ chức mới', 'System', TRUE, TRUE, FALSE),
('update Organization', 'PutOrganization', 'Cập nhật thông tin tổ chức', 'System', TRUE, TRUE, FALSE),
('Delete Organization', 'DeleteOrganization', 'Xóa một tổ chức', 'System', TRUE, TRUE, FALSE),
('view Organizations', 'GetOrganizations', 'Xem danh sách tổ chức', 'System', TRUE, TRUE, FALSE),
('add Organizations', 'PostOrganizations', 'Thêm nhiều tổ chức', 'System', TRUE, TRUE, FALSE),
('update Organizations', 'PutOrganizations', 'Cập nhật danh sách tổ chức', 'System', TRUE, TRUE, FALSE),
('Delete Organizations', 'DeleteOrganizations', 'Xóa nhiều tổ chức', 'System', TRUE, TRUE, FALSE),
('export Organizations', 'ExportOrganizations', 'Xuất khẩu danh sách excell', 'System', TRUE, TRUE, FALSE);



INSERT INTO rights (name, code, description, createdBy,isSystem,isOwner,isOrganization) VALUES
-- organizations template contents
('view OrganizationsTemplateContent', 'GetOrganizationsTemplateContent', 'Xem nội dung mẫu của tổ chức', 'System', TRUE, TRUE, FALSE),
('add OrganizationsTemplateContent', 'PostOrganizationsTemplateContent', 'Thêm nội dung mẫu của tổ chức', 'System', TRUE, TRUE, FALSE),
('update OrganizationsTemplateContent', 'PutOrganizationsTemplateContent', 'Cập nhật nội dung mẫu của tổ chức', 'System', TRUE, TRUE, FALSE),
('Delete OrganizationsTemplateContent', 'DeleteOrganizationsTemplateContent', 'Xóa nội dung mẫu của tổ chức', 'System', TRUE, TRUE, FALSE);

-- organization template contents
('view OrganizationTemplateContent', 'GetOrganizationTemplateContent', 'Xem nội dung mẫu của tổ chức', 'System', TRUE, TRUE, FALSE),
('add OrganizationTemplateContent', 'PostOrganizationTemplateContent', 'Thêm nội dung mẫu của tổ chức', 'System', TRUE, TRUE, FALSE),
('update OrganizationTemplateContent', 'PutOrganizationTemplateContent', 'Cập nhật nội dung mẫu của tổ chức', 'System', TRUE, TRUE, FALSE),
('Delete OrganizationTemplateContent', 'DeleteOrganizationTemplateContent', 'Xóa nội dung mẫu của tổ chức', 'System', TRUE, TRUE, FALSE);



INSERT INTO rights (name, code, description, createdBy,isSystem,isOwner,isOrganization) VALUES
-- branch template contents
('view BranchTemplateContent', 'GetBranchTemplateContent', 'Xem nội dung mẫu của chi nhánh', 'System', TRUE, TRUE, TRUE),
('add BranchTemplateContent', 'PostBranchTemplateContent', 'Thêm nội dung mẫu của chi nhánh', 'System', TRUE, TRUE, TRUE),
('update BranchTemplateContent', 'PutBranchTemplateContent', 'Cập nhật nội dung mẫu của chi nhánh', 'System', TRUE, TRUE, TRUE),
('Delete BranchTemplateContent', 'DeleteBranchTemplateContent', 'Xóa nội dung mẫu của chi nhánh', 'System', TRUE, TRUE, TRUE),

-- branches template contents
('view BranchesTemplateContent', 'GetBranchesTemplateContent', 'Xem nội dung mẫu của nhiều chi nhánh', 'System', TRUE, TRUE, TRUE),
('add BranchesTemplateContent', 'PostBranchesTemplateContent', 'Thêm nội dung mẫu của nhiều chi nhánh', 'System', TRUE, TRUE, TRUE),
('update BranchesTemplateContent', 'PutBranchesTemplateContent', 'Cập nhật nội dung mẫu của nhiều chi nhánh', 'System', TRUE, TRUE, TRUE),
('Delete BranchesTemplateContent', 'DeleteBranchesTemplateContent', 'Xóa nội dung mẫu của nhiều chi nhánh', 'System', TRUE, TRUE, TRUE);


INSERT INTO rights (name, code, description, createdBy,isSystem,isOwner,isOrganization) VALUES
-- right template contents
('view RightTemplateContent', 'GetRightTemplateContent', 'Xem nội dung mẫu của quyền', 'System', TRUE, TRUE, TRUE),
('add RightTemplateContent', 'PostRightTemplateContent', 'Thêm nội dung mẫu của quyền', 'System', TRUE, TRUE, TRUE),
('update RightTemplateContent', 'PutRightTemplateContent', 'Cập nhật nội dung mẫu của quyền', 'System', TRUE, TRUE, TRUE),
('Delete RightTemplateContent', 'DeleteRightTemplateContent', 'Xóa nội dung mẫu của quyền', 'System', TRUE, TRUE, TRUE),


-- rights template contents
('view RightsTemplateContent', 'GetRightsTemplateContent', 'Xem nội dung mẫu của quyền', 'System', TRUE, TRUE, TRUE),
('add RightsTemplateContent', 'PostRightsTemplateContent', 'Thêm nội dung mẫu của quyền', 'System', TRUE, TRUE, TRUE),
('update RightsTemplateContent', 'PutRightsTemplateContent', 'Cập nhật nội dung mẫu của quyền', 'System', TRUE, TRUE, TRUE),
('Delete RightsTemplateContent', 'DeleteRightsTemplateContent', 'Xóa nội dung mẫu của quyền', 'System', TRUE, TRUE, TRUE),

-- rights of owner template contents
('view RightsOfOwnerTemplateContent', 'GetRightsOfOwnerTemplateContent', 'Xem nội dung mẫu của quyền chủ sở hữu', 'System', TRUE, TRUE, TRUE),
('add RightsOfOwnerTemplateContent', 'PostRightsOfOwnerTemplateContent', 'Thêm nội dung mẫu của quyền chủ sở hữu', 'System', TRUE, TRUE, TRUE),
('update RightsOfOwnerTemplateContent', 'PutRightsOfOwnerTemplateContent', 'Cập nhật nội dung mẫu của quyền chủ sở hữu', 'System', TRUE, TRUE, TRUE),
('Delete RightsOfOwnerTemplateContent', 'DeleteRightsOfOwnerTemplateContent', 'Xóa nội dung mẫu của quyền chủ sở hữu', 'System', TRUE, TRUE, TRUE);

INSERT INTO rights (name, code, description, createdBy,isSystem,isOwner,isOrganization) VALUES
-- role template contents
('view RoleTemplateContent', 'GetRoleTemplateContent', 'Xem nội dung mẫu của vai trò', 'System', TRUE, TRUE, TRUE),
('add RoleTemplateContent', 'PostRoleTemplateContent', 'Thêm nội dung mẫu của vai trò', 'System', TRUE, TRUE, TRUE),
('update RoleTemplateContent', 'PutRoleTemplateContent', 'Cập nhật nội dung mẫu của vai trò', 'System', TRUE, TRUE, TRUE),
('Delete RoleTemplateContent', 'DeleteRoleTemplateContent', 'Xóa nội dung mẫu của vai trò', 'System', TRUE, TRUE, TRUE),
-- roles template contents
('view RolesTemplateContent', 'GetRolesTemplateContent', 'Xem nội dung mẫu của nhiều vai trò', 'System', TRUE, TRUE, TRUE),
('add RolesTemplateContent', 'PostRolesTemplateContent', 'Thêm nội dung mẫu của nhiều vai trò', 'System', TRUE, TRUE, TRUE),
('update RolesTemplateContent', 'PutRolesTemplateContent', 'Cập nhật nội dung mẫu của nhiều vai trò', 'System', TRUE, TRUE, TRUE),
('Delete RolesTemplateContent', 'DeleteRolesTemplateContent', 'Xóa nội dung mẫu của nhiều vai trò', 'System', TRUE, TRUE, TRUE);

INSERT INTO rights (name, code, description, createdBy,isSystem,isOwner,isOrganization) VALUES
-- department template contents
('view DepartmentTemplateContent', 'GetDepartmentTemplateContent', 'Xem nội dung mẫu của phòng ban', 'System', TRUE, TRUE, TRUE),
('add DepartmentTemplateContent', 'PostDepartmentTemplateContent', 'Thêm nội dung mẫu của phòng ban', 'System', TRUE, TRUE, TRUE),
('update DepartmentTemplateContent', 'PutDepartmentTemplateContent', 'Cập nhật nội dung mẫu của phòng ban', 'System', TRUE, TRUE, TRUE),
('Delete DepartmentTemplateContent', 'DeleteDepartmentTemplateContent', 'Xóa nội dung mẫu của phòng ban', 'System', TRUE, TRUE, TRUE),

-- departments template contents
('view DepartmentsTemplateContent', 'GetDepartmentsTemplateContent', 'Xem nội dung mẫu của nhiều phòng ban', 'System', TRUE, TRUE, TRUE),
('add DepartmentsTemplateContent', 'PostDepartmentsTemplateContent', 'Thêm nội dung mẫu của nhiều phòng ban', 'System', TRUE, TRUE, TRUE),
('update DepartmentsTemplateContent', 'PutDepartmentsTemplateContent', 'Cập nhật nội dung mẫu của nhiều phòng ban', 'System', TRUE, TRUE, TRUE),
('Delete DepartmentsTemplateContent', 'DeleteDepartmentsTemplateContent', 'Xóa nội dung mẫu của nhiều phòng ban', 'System', TRUE, TRUE, TRUE);

INSERT INTO rights (name, code, description, createdBy,isSystem,isOwner,isOrganization) VALUES
-- user department role template contents
('view UserDepartmentRoleTemplateContent', 'GetUserDepartmentRoleTemplateContent', 'Xem nội dung mẫu của vai trò người dùng theo phòng ban', 'System', TRUE, TRUE, TRUE),
('add UserDepartmentRoleTemplateContent', 'PostUserDepartmentRoleTemplateContent', 'Thêm nội dung mẫu của vai trò người dùng theo phòng ban', 'System', TRUE, TRUE, TRUE),
('update UserDepartmentRoleTemplateContent', 'PutUserDepartmentRoleTemplateContent', 'Cập nhật nội dung mẫu của vai trò người dùng theo phòng ban', 'System', TRUE, TRUE, TRUE),
('Delete UserDepartmentRoleTemplateContent', 'DeleteUserDepartmentRoleTemplateContent', 'Xóa nội dung mẫu của vai trò người dùng theo phòng ban', 'System', TRUE, TRUE, TRUE),

-- users department roles template contents
('view UsersDepartmentRolesTemplateContent', 'GetUsersDepartmentRolesTemplateContent', 'Xem nội dung mẫu của nhiều vai trò người dùng theo phòng ban', 'System', TRUE, TRUE, TRUE),
('add UsersDepartmentRolesTemplateContent', 'PostUsersDepartmentRolesTemplateContent', 'Thêm nội dung mẫu của nhiều vai trò người dùng theo phòng ban', 'System', TRUE, TRUE, TRUE),
('update UsersDepartmentRolesTemplateContent', 'PutUsersDepartmentRolesTemplateContent', 'Cập nhật nội dung mẫu của nhiều vai trò người dùng theo phòng ban', 'System', TRUE, TRUE, TRUE),
('Delete UsersDepartmentRolesTemplateContent', 'DeleteUsersDepartmentRolesTemplateContent', 'Xóa nội dung mẫu của nhiều vai trò người dùng theo phòng ban', 'System', TRUE, TRUE, TRUE);

-- gán tất cả quyền vào Administrator không có vai trò isOwner và không có tổ chức là RootOrganization
INSERT IGNORE INTO roles_rights (roleId, rightId, isActive)
SELECT r.id, rt.id, TRUE
FROM roles r
JOIN rights rt ON rt.isOwner = FALSE
WHERE r.code = 'Administrator'AND r.organizationId <> @RootOrganization;

-- gán tất cả quyền vào Administrator có vai trò isOwner và có tổ chức là RootOrganization
INSERT IGNORE INTO roles_rights (roleId, rightId, isActive)
SELECT r.id, rt.id, TRUE
FROM roles r
JOIN rights rt ON rt.isOwner = TRUE
WHERE r.code = 'Administrator' AND r.organizationId = @RootOrganization;

-- xoá bỏ quyền với right.isOrganization = FALSE khỏi Administrator với organization khác RootOrganization
DELETE rr
FROM roles_rights rr
JOIN roles r ON rr.roleId = r.id
JOIN rights rt ON rr.rightId = rt.id
WHERE r.code = 'Administrator' AND r.organizationId <> @RootOrganization AND rt.isOrganization = FALSE;
